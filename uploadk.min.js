/*! uploadk 2016-01-01 - alexis.baranger91@gmail.com */
var app=angular.module("uploadk",[]);angular.module("uploadk").directive("catchFiles",["$rootScope","$timeout","$window",function(a,b,c){return{restrict:"A",scope:!0,link:function(a,b,c){function d(){var d=this;if(d.callback=a.$eval(c.catchFiles)||a.$eval(c.onDrop),!d.callback)throw new Error("Error : no callback defined for fileCatcher directive");c.onDragEnter&&(d.onDragEnterCallback=a.$eval(c.onDragEnter)),c.onDragLeave&&(d.onDragLeaveCallback=a.$eval(c.onDragLeave)),d.options=e;var f=a.$eval(c.catchOptions);angular.extend(d.options,f),b.bind("dragover",d.onDrag),b.bind("dragenter",d.onEnter),b.bind("dragleave",d.onLeave),d.initInput(),b.on("click",function(b){return d.ignore||!a.$eval(c.catchIf)?void(d.ignore=!0):void document.getElementById("input-file").click()}),this._addEvent(b[0],"drop",d.onDrop)}var e={multiple:!0,drag:!0,click:!1};d.prototype._addEvent=function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,c)},d.prototype._getTransfer=function(a){return a.dataTransfer||a.originalTarget||a.target},d.prototype._preventAndStop=function(a){a.preventDefault(),a.stopPropagation()},d.prototype.onEnter=function(a){f.onDragEnterCallback&&f.onDragEnterCallback(a)},d.prototype.onLeave=function(a){f.onDragLeaveCallback&&f.onDragLeaveCallback(a)},d.prototype.onDrop=function(b){if(f.ignore||!a.$eval(c.catchIf))return void(f.ignore=!0);f._preventAndStop(b);var d=f._getTransfer(b);if(d&&("drop"==b.type||"change"==b.type)&&f.callback&&"function"==typeof f.callback){var e=d.files;f.options.multiple===!0?f.callback(e):f.callback(e[0])}},d.prototype.onDrag=function(a){var b=f._getTransfer(a);b.dropEffect="copy",f._preventAndStop(a)},d.prototype.initInput=function(){var a=angular.element('<input id="input-file" style="display:none;" type="file" multiple="multiple"/>');a.on("change",function(a){f.onDrop(a)}),b.append(a)};var f=new d}}}]),angular.module("uploadk").factory("canvas",["$q",function(a){var b=function(b,c){var d=a.defer(),e=document.createElement("canvas");e.width=c||100,e.height=c||100;var f=e.getContext("2d"),g=new Image;return g.src=b,g.onload=function(){var a=g.width,b=g.height,h=0,i=0,j=0;a>=b?(h=b,i=(a-h)/2):(h=a,j=(b-h)/2),f.drawImage(g,i,j,h,h,0,0,c,c);var k=e.toDataURL("image/png");d.resolve(k)},d.promise};return{make:b}}]),angular.module("uploadk").factory("fileReader",["$q",function(a){var b=function(a,b,c){return function(){c.$apply(function(){b.resolve(a.result)})}},c=function(a,b,c){return function(){c.$apply(function(){b.reject(a.result)})}},d=function(a,b){return function(a){b.$broadcast("fileProgress",{total:a.total,loaded:a.loaded})}},e=function(a,e){var f=new FileReader;return f.onload=b(f,a,e),f.onerror=c(f,a,e),f.onprogress=d(f,e),f},f=function(b,c){var d=a.defer(),f=e(d,c);return f.readAsDataURL(b),d.promise};return{readAsDataUrl:f}}]),angular.module("uploadk").factory("fileUploader",["$rootScope","$q",function(a,b){return{post:function(c,d){return{to:function(e,f){var g=b.defer();if(!c||0==c.length)return g.reject("No files to upload"),g.promise;c&&c instanceof Array==0&&(c=[c]);var h=new XMLHttpRequest;h.upload.onprogress=function(a){var b;a.lengthComputable&&(b=Math.round(a.loaded/a.total*100),g.notify&&g.notify({prct:b,files:c}))},h.onload=function(b){var d=a.$eval(h.response)||h.responseText||null,e={dropped:c,response:d,status:h.status};h.status>=0&&h.status<300?g.resolve(e):h.status>=300&&h.status<1e3&&g.reject(e)},h.upload.onerror=function(a){var b="An error occurred while posting to '"+e+"'";g.reject(b)},h.parseHeaders=function(){if(f&&f instanceof Object)for(var a in f)h.setRequestHeader(a,f[a])};for(var i=new FormData,j=0;j<c.length;j++)i.append(c[j].name,c[j]);return d=d||"POST",h.open(d,e,!0),h.parseHeaders(),h.send(i),g.promise}}}}}]);